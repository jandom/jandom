---
layout: post
title: Testing modern Symfony apps
date: '2016-06-04T02:32:00.001-07:00'
author: jandom
tags: 
modified_time: '2016-06-04T03:11:10.852-07:00'
blogger_id: tag:blogger.com,1999:blog-2967594273163880803.post-8950137088843340785
blogger_orig_url: https://jandomanski.blogspot.com/2016/06/testing-modern-symfony-apps.html
---

<h3>Introduction</h3>The words "modern" and "PHP framework" would usually be considered oxymorons – and for good reasons. However, here is no point in denying that a large number of things on the internet relies on Symfony or some other PHP framework to run. These things will be gradually phased out or upgraded but for now they can't just remain untested because they're somewhat (out)dated...<br /><br /><h3>API testing</h3>The more rigorous part is RESTful API testing that relies on sending json to server and getting server back from the server. Let's create a boilerplate class that's going to help us send POST/GET/DELETE requests wrapped around as methods:<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <?php  namespace YourApp\ApiBundle\Tests\Controller;  use Symfony\Bundle\FrameworkBundle\Test\WebTestCase; use Symfony\Component\HttpFoundation\Response;  class ApiTestCase extends WebTestCase {      /*      */     protected function post($uri, array $data)     {         $headers = array('CONTENT_TYPE' => 'application/json', "HTTP_APIKEY" => $this->apikey);         $content = json_encode($data);         $client = static::createClient();         $client->request('POST', $uri, array(), array(), $headers, $content);          return $client->getResponse();     }      protected function get($uri)     {         $headers = array('CONTENT_TYPE' => 'application/json', "HTTP_APIKEY" => $this->apikey);         $client = static::createClient();         $client->request('GET', $uri, array(), array(), $headers);          return $client->getResponse();     }       protected function delete($uri)     {         $headers = array('CONTENT_TYPE' => 'application/json', "HTTP_APIKEY" => $this->apikey);         $client = static::createClient();         $client->request('DELETE', $uri, array(), array(), $headers);          return $client->getResponse();     }  }  ]]></script> <br /><div>And now we're going to use that ancestor class to facilitate some real-life testing of user profile reads and updates.<br /><br /><script class="brush:php" type="syntaxhighlighter"><![CDATA[ <?php  namespace YourApp\ApiBundle\Tests\Controller;  use Symfony\Component\HttpFoundation\Response;  /* https://github.com/symfony/symfony/blob/master/src/Symfony/Component/HttpFoundation/Response.php#L23 */ class UserControllerTest extends ApiTestCase {      protected $apikey = "YourLongAndComplicatedAPIKey";      public function testUpdateUserProfile()     {          $form = ['user'=> ['name' => 'John Smith', 'profile'=>['location'=>'', 'research_interests'=>'', 'organisation'=>'', 'publications'=>'' ] ]];          $response = $this->post('/api/users/1.json', $form);         $content = $response->getContent();          $this->assertSame(Response::HTTP_CREATED, $response->getStatusCode());          $object = json_decode($content);         $this->assertEquals($object->success, true);     }      public function testUpdateUserProfileIncompleted()     {          $form = ['user'=> ['name' => 'John Smith']];          $response = $this->post('/api/users/1.json', $form);         $content = $response->getContent();          $this->assertSame(Response::HTTP_CREATED, $response->getStatusCode());          $object = json_decode($content);         $this->assertEquals($object->success, true);     }      public function testUpdateUserProfileInvalid()     {          $form = ['user'=> ['nameeee' => 'John Smith']];          $response = $this->post('/api/users/1.json', $form);         $content = $response->getContent();          $this->assertSame(Response::HTTP_BAD_REQUEST, $response->getStatusCode());         $object = json_decode($content);          $this->assertEquals($object->errors->errors[0], "This form should not contain extra fields.");     }  } ]]></script>To run the tests do the following<br /><script class="brush:bash" type="syntaxhighlighter"><![CDATA[ phpunit -c app src/YourApp/ApiBundle/Tests/Controller/ ]]></script> <br /><h3>Frontend functional/flow testing</h3></div><div>While valuable, the API testing will not cover certain aspects of the application flow. For example you changed some &lt;script&gt; dependency version loaded from a CDN. Your API works fine but for whatever reason your JS code will die (this happened to us with react-bootstrap which deprecated the ModalTrigger component at some point).<br /><br />Here is a simple test in mocha.js and zombie.js that will attempt to log the user in and see if the content pages even load. No interaction, just "does it load?".<br /><br /> <script class="brush:js" type="syntaxhighlighter"><![CDATA[ var expect = require('expect.js'), Browser = require('zombie');  // http://www.redotheweb.com/2013/01/15/functional-testing-for-nodejs-using-mocha-and-zombie-js.html  // tests describe('quick', function() {      const browser = new Browser({site: "http://127.0.0.1:8000/app_dev.php"});     const user = { username: "test@youapp.com", password: "SomePassword" }      describe('login as user', function() {       // load the contact page       before(function(done) {           browser.visit('/login', done);       });        it('should show login form', function() {           browser.assert.success();           browser.assert.text('title', 'Log In');       });        it('should login with correct credentials', function(done){           browser.fill('_username', user.username);           browser.fill('_password', user.password);           browser.pressButton('Login').then(function() {               expect(browser.text("title")).to.equal('Labstep – legitimate and replicable protocols');               expect(browser.text("ul.authenticated")).to.contain('Welcome to Labstep');               expect(browser.text("h2.special")).to.contain('Experimental timeline');           }).then(done, done);       });     });      describe('visit /home', function() {       // load the contact page       before(function(done) {           browser.visit('/home', done);       });        it('should show the create post button', function() {           browser.assert.success();           expect(browser.text("button")).to.contain('Create a Timeline Post');       });     });      describe('visit /protocols', function() {       // load the contact page       before(function(done) {           browser.visit('/protocols', done);       });        it('should a group in protocol discovery', function() {           browser.assert.success();           expect(browser.text("span")).to.contain('Wiley Group');       });     });      describe('visit /group/1', function() {       // load the contact page       before(function(done) {           browser.visit('/group/1', done);       });        it('should show show an example protocol', function() {           browser.assert.success();           expect(browser.text("a")).to.contain('Qiagen minipreptest');       });     });  }); ]]></script> Then to run the test<br /><script class="brush:bash" type="syntaxhighlighter"><![CDATA[ mocha tests/functional/quick/quick.js ]]></script> </div>