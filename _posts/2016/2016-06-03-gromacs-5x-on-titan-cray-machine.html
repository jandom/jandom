---
layout: post
title: Gromacs 5.x on TITAN Cray machine
date: '2016-06-03T08:28:00.000-07:00'
author: jandom
tags: 
modified_time: '2016-06-08T08:42:24.765-07:00'
blogger_id: tag:blogger.com,1999:blog-2967594273163880803.post-1189317326607145637
blogger_orig_url: https://jandomanski.blogspot.com/2016/06/gromacs-5x-on-titan-cray-machine.html
---

For compilation instructions checkout&nbsp;https://groups.google.com/d/msg/plumed-users/Tx29XNNRq8o/xeAu7RNaBAAJ<br /><br />For a while we've been preparing to run some simulations on this machine, hosted by Oak Ridge National Lab. Every cluster is a bit different and that's definitely true for <a href="https://en.wikipedia.org/wiki/Titan_(supercomputer)">TITAN</a>: each box has 16 CPUs (arranged in 2 "numas") and 1 K20 nVidia GPU. There is no usual MPI or Infiniband, there is some other Cray-specific beast.<br /><br />Here is an example submission script for a non-replica exchange simulation:<br /><br /><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">#!/bin/bash</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal; min-height: 13px;"><span style="font-variant-ligatures: no-common-ligatures;"></span><br /></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">module add&nbsp;</span>gromacs/5.0.2</div><div style="font-family: Menlo; font-size: 11px; line-height: normal; min-height: 13px;"><span style="font-variant-ligatures: no-common-ligatures;"></span><br /></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;">cd $PBS_O_WORKDIR</div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;"># important - allow the GPU to be shared between MPI ranks</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">export CRAY_CUDA_MPS=1</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal; min-height: 13px;"><span style="font-variant-ligatures: no-common-ligatures;"></span><br /></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">mpirun=`which aprun`</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">application=`which mdrun_mpi`</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal; min-height: 13px;"><span style="font-variant-ligatures: no-common-ligatures;"></span><br /></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">options="-v -maxh 0.2 -s tpr/topol0.tpr "</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal; min-height: 13px;"><br /><span style="font-variant-ligatures: no-common-ligatures;"></span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;">gpu_id=000000000000 # only 12, discard last '0000'</div><br /><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">$mpirun -n 32 -N 16 $application -gpu_id $gpu_id&nbsp; $options</span></div><div><br /></div><div><span style="font-variant-ligatures: no-common-ligatures;">Submit with<br /></span><br /><div><span style="font-variant-ligatures: no-common-ligatures;"><br /></span></div><span style="font-variant-ligatures: no-common-ligatures;"></span></div><div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">$ qsub -l walltime=1:00:00 -l nodes=2 submit.sh</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;"><br /></span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;"></span></div>Requesting for 2 boxes, start 32 MPI processes/ranks, 16 per box. Implicitly, this will result in 1 OpenMP thread per 1 MPI process. From single nodes simulations, let me explain this choice:<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-size: 13px;">1,16,2,5.346 ns/day</span><br style="font-size: 13px;" /><span style="font-size: 13px;">1,16,4,10.590</span><span style="font-size: 13px;">&nbsp;ns/day</span><br style="font-size: 13px;" /><span style="font-size: 13px;">1,16,8,17.402</span><span style="font-size: 13px;">&nbsp;ns/day</span><br style="font-size: 13px;" /><span style="font-size: 13px;">1,16,16,33.137</span><span style="font-size: 13px;">&nbsp;</span><span style="font-size: 13px;">ns/day</span></span><br /><span style="font-family: &quot;segoe ui&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 13px;"><br /></span><span style="font-family: &quot;segoe ui&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 13px;">First column is nodes=1, second column is -n 16 MPI ranks requested, third column is -N MPI ranks per node. At -N 2, we get 8 OpenMP threads per 1 MPI process, this is known to be non-ideal.&nbsp;</span><br /><span style="font-family: &quot;segoe ui&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 13px;"><br /></span><span style="font-family: &quot;segoe ui&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 13px;">Keeping this -N 16 constant, let's add more nodes</span><br /><span style="font-family: &quot;segoe ui&quot; , &quot;helvetica&quot; , &quot;arial&quot; , sans-serif; font-size: 13px;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-size: 13px;">#setup,performance</span><br style="font-size: 13px;" /><span style="font-size: 13px;">nodes-1__n-16_N-16,33.137</span><br style="font-size: 13px;" /><span style="font-size: 13px;">nodes-2__n-32_N-16,49.975</span><br style="font-size: 13px;" /><span style="font-size: 13px;">nodes-4__n-64_N-16,78.244</span></span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace;"><span style="font-size: 13px;"><br /></span></span><br /></div><div><br /></div>