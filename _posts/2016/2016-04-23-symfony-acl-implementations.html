---
layout: post
title: Symfony cumulative ACL isGranted
date: '2016-04-23T14:27:00.000-07:00'
author: jandom
tags: 
modified_time: '2016-04-26T00:34:27.130-07:00'
blogger_id: tag:blogger.com,1999:blog-2967594273163880803.post-2300221585378701215
blogger_orig_url: https://jandomanski.blogspot.com/2016/04/symfony-acl-implementations.html
---

The default use of Access Control Lists in symfony can be a little awkward. That's because the $securityContext isGranted method performs a cumulative permissions check, while the typical implementations of ACL component isGranted perform a different kind of check. Here is what I mean, let's start with a simple security token.<br /><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$em = $this-&gt;getContainer()-&gt;get('doctrine')-&gt;getManager();</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$aclManager = $this-&gt;getContainer()-&gt;get('myapp_user.acl_manager');</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$repository = $em-&gt;getRepository('MyAppUserBundle:User');</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$user = $repository-&gt;find(1);</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><br /></span><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$output-&gt;writeln(sprintf("user:%d %s", $user-&gt;getId(), $user-&gt;getUsername() ) );</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$token = new UsernamePasswordToken($user, $user-&gt;getPassword(), "firewallname", $user-&gt;getRoles());</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$securityContext = $this-&gt;getContainer()-&gt;get('security.token_storage');</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$authorizationChecker = $this-&gt;getContainer()-&gt;get('security.authorization_checker');&nbsp;</span><br /><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$securityContext-&gt;setToken($token);</span><br /><div><br /></div><div>Then let's print off an ACL record for an example object&nbsp;</div><div><br /></div><div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$aclManager = $this-&gt;getContainer()-&gt;get('myapp_user.acl_manager');</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$repository = $em-&gt;getRepository('MyAppCoreBundle:Comment');</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$entity = $repository-&gt;find(1);</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$acl = $aclManager-&gt;getAcl($entity);</span></div><div><br /></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">foreach ( $acl-&gt;getObjectAces() as $ace ) {</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; $output-&gt;writeln(sprintf("%s %s\n", $ace-&gt;getSecurityIdentity(), $ace-&gt;getMask()););</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">}</span></div></div><div><br /></div><div>We get a fairly straightforward&nbsp;</div><div><br /></div><div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">RoleSecurityIdentity(ROLE_GROUP_1) 1</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">RoleSecurityIdentity(ROLE_GROUP_OWNER_1) 128</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">UserSecurityIdentity(test@labstep.com, LabStep\UserBundle\Entity\User) 128</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;"><br /></span></div></div><div><span style="font-variant-ligatures: no-common-ligatures;">There is a single user, who has owner permissions over the comment object. There is also some group (GROUP_1), its users can view (1) and its owners can own (128) the comment. Let's confirm that...</span></div><div><span style="font-variant-ligatures: no-common-ligatures;"><br /></span></div><div><span style="font-variant-ligatures: no-common-ligatures;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"></span></span><br /><div><span style="font-variant-ligatures: no-common-ligatures;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$output-&gt;writeln((false === $authorizationChecker-&gt;isGranted("VIEW", $entity) ? "not granted": "granted"));</span></span></div><span style="font-variant-ligatures: no-common-ligatures;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><div>$output-&gt;writeln((false === $authorizationChecker-&gt;isGranted("OWNER", $entity) ? "not granted": "granted"));</div></span></span></div><div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">granted</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">granted</span></div></div><div><span style="font-variant-ligatures: no-common-ligatures;"><br /></span></div><div><span style="font-variant-ligatures: no-common-ligatures;">Ok, awesome – the user has OWNER (128) permission – so both OWNER and VIEW are granted: duh, of course an owner can view what they own. </span></div><div><span style="font-variant-ligatures: no-common-ligatures;"><br /></span></div><div>Let's use some standard isGranted implementation to check the roles, like the one from <a href="http://stackoverflow.com/questions/24078270/check-if-a-role-is-granted-for-a-specific-user-in-symfony2-acl">here</a></div><div><div><br /></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$securityIdentity = new RoleSecurityIdentity(sprintf("ROLE_GROUP_OWNER_%d", 1));</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$output-&gt;writeln((false === $aclManager-&gt;isGranted("VIEW", $entity, $securityIdentity) ? "not granted": "granted" ));</span></div><div><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">$output-&gt;writeln((false === $aclManager-&gt;isGranted("OWNER", $entity, $securityIdentity) ? "not granted": "granted" ));</span></div></div><div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">not granted</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">granted</span></div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><br /></div></div><div>The ROLE_GROUP_OWNER_1 is OWNER of this entity but is not granted to VIEW this entity? WTF? Clearly this check is not cumulative – being an owner doesn't equate being able to view the entity. This is very confusing but is nonetheless correct. So what does the authorization checker do under the hood, to provide a different behavior to the $aclManager?&nbsp;</div><div><br /></div><div>Well the following file</div><div><div style="font-family: Menlo; font-size: 11px; line-height: normal;"><span style="font-variant-ligatures: no-common-ligatures;">vendor//symfony/symfony/src/Symfony/Component/Security/Acl/Permission/BasicPermissionMap.php</span></div><div style="line-height: normal;">Provides a mapping that basically means that an owner permission will be transformed into a mask that includes all the masks below OWNER in hierarchy.&nbsp;</div><div style="line-height: normal;"><br /></div><div style="line-height: normal;">Here is an alternative example of isGranted that gives a more intuitive behavior to the commonly found example</div><div style="line-height: normal;"><br /><code><span class="pln"></span></code><code><span class="kwd">use</span><span class="pln"> </span><span class="typ">Symfony</span><span class="pln">\Component\Security\Acl\Permission\BasicPermissionMap</span><span class="pun">;</span><span class="pln">&nbsp;</span></code><br /><pre class="lang-php prettyprint prettyprinted"><code><span class="pln">&nbsp;</span></code></pre></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">public function isGranted($mask, $object, $securityIdentities) &nbsp;{</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; $objectIdentity = ObjectIdentity::fromDomainObject($object);</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; if (!is_array($securityIdentities)) {</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; $securityIdentities = array($securityIdentities);</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; }</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; // Find all the ACL records</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; try {</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; $acl = $this-&gt;provider-&gt;findAcl($objectIdentity, $securityIdentities);</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; } catch (AclNotFoundException $e) {</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; return false;</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; }</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><br /></span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; if (!is_int($mask)) {</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; $permissionMap = new BasicPermissionMap();</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; $masks = $permissionMap-&gt;getMasks($mask, null);</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; }</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; else {</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; $masks = arary($mask);</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; }</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;"><br /></span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; // Perform the check</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; try {</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; return $acl-&gt;isGranted($masks, $securityIdentities, false);</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; } catch (NoAceFoundException $e) {</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; &nbsp; &nbsp; return false;</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">&nbsp; &nbsp; }</span></div><div style="line-height: normal;"><span style="font-family: &quot;courier new&quot; , &quot;courier&quot; , monospace; font-size: x-small;">}</span><br /><br /><br />Edits: the title was changed - it wasn't really descriptive of the post. Added a missing 'use' statement for the BasicPermissionMap</div></div>